<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Configuration - Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <style>
        .config-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .preview-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            min-height: 300px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .query-editor {
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .data-source-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .data-source-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .data-source-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .chart-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .chart-type-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chart-type-card:hover {
            border-color: #0d6efd;
            transform: translateY(-2px);
        }
        .chart-type-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .chart-type-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #6c757d;
        }
        .chart-type-card.selected .chart-type-icon {
            color: #0d6efd;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        .step.active::after {
            background: #0d6efd;
        }
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 2;
        }
        .step.active .step-circle {
            background: #0d6efd;
        }
        .step.completed .step-circle {
            background: #28a745;
        }
        .advanced-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <small>Data Source</small>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <small>Chart Type</small>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <small>Query</small>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <small>Styling</small>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-circle">5</div>
                        <small>Preview</small>
                    </div>
                </div>

                <!-- Step 1: Data Source Selection -->
                <div class="config-section" id="dataSourceStep">
                    <h4><i class="fas fa-database me-2"></i>Select Data Source</h4>
                    <p class="text-muted">Choose the data source for your widget</p>
                    
                    <div id="dataSourceList">
                        <!-- Data sources will be loaded dynamically -->
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-primary" onclick="testConnection()">
                            <i class="fas fa-plug me-2"></i>Test Connection
                        </button>
                        <button class="btn btn-primary float-end" onclick="nextStep(2)">
                            Next <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Chart Type Selection -->
                <div class="config-section" id="chartTypeStep" style="display: none;">
                    <h4><i class="fas fa-chart-bar me-2"></i>Choose Chart Type</h4>
                    <p class="text-muted">Select the visualization type that best represents your data</p>
                    
                    <div class="chart-type-grid">
                        <div class="chart-type-card" onclick="selectChartType('line')">
                            <div class="chart-type-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>Line Chart</div>
                            <small class="text-muted">Time series data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('bar')">
                            <div class="chart-type-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>Bar Chart</div>
                            <small class="text-muted">Categorical data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('pie')">
                            <div class="chart-type-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>Pie Chart</div>
                            <small class="text-muted">Proportional data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('scatter')">
                            <div class="chart-type-icon">
                                <i class="fas fa-braille"></i>
                            </div>
                            <div>Scatter Plot</div>
                            <small class="text-muted">Correlation data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('heatmap')">
                            <div class="chart-type-icon">
                                <i class="fas fa-th"></i>
                            </div>
                            <div>Heatmap</div>
                            <small class="text-muted">Matrix data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('histogram')">
                            <div class="chart-type-icon">
                                <i class="fas fa-chart-area"></i>
                            </div>
                            <div>Histogram</div>
                            <small class="text-muted">Distribution data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('box')">
                            <div class="chart-type-icon">
                                <i class="fas fa-square"></i>
                            </div>
                            <div>Box Plot</div>
                            <small class="text-muted">Statistical data</small>
                        </div>
                        <div class="chart-type-card" onclick="selectChartType('gauge')">
                            <div class="chart-type-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div>Gauge</div>
                            <small class="text-muted">Single metric</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="previousStep(1)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <button class="btn btn-primary float-end" onclick="nextStep(3)">
                            Next <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Query Configuration -->
                <div class="config-section" id="queryStep" style="display: none;">
                    <h4><i class="fas fa-code me-2"></i>Configure Query</h4>
                    <p class="text-muted">Define the query to fetch your data</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Query Type</label>
                                <select class="form-select" id="queryType" onchange="updateQueryEditor()">
                                    <option value="sql">SQL Query</option>
                                    <option value="prometheus">Prometheus Query</option>
                                    <option value="elasticsearch">Elasticsearch Query</option>
                                    <option value="influxdb">InfluxDB Query</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Time Range</label>
                                <select class="form-select" id="timeRange">
                                    <option value="5m">Last 5 minutes</option>
                                    <option value="15m">Last 15 minutes</option>
                                    <option value="1h" selected>Last 1 hour</option>
                                    <option value="6h">Last 6 hours</option>
                                    <option value="24h">Last 24 hours</option>
                                    <option value="7d">Last 7 days</option>
                                    <option value="30d">Last 30 days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Query</label>
                        <div class="query-editor">
                            <textarea id="queryEditor" placeholder="Enter your query here..."></textarea>
                        </div>
                    </div>
                    
                    <div class="advanced-options">
                        <h6><i class="fas fa-cogs me-2"></i>Advanced Options</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Refresh Interval (seconds)</label>
                                    <input type="number" class="form-control" id="refreshInterval" value="30" min="5">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Max Data Points</label>
                                    <input type="number" class="form-control" id="maxDataPoints" value="1000" min="10">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Aggregation</label>
                                    <select class="form-select" id="aggregation">
                                        <option value="none">None</option>
                                        <option value="avg">Average</option>
                                        <option value="sum">Sum</option>
                                        <option value="min">Minimum</option>
                                        <option value="max">Maximum</option>
                                        <option value="count">Count</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-primary" onclick="testQuery()">
                            <i class="fas fa-play me-2"></i>Test Query
                        </button>
                        <button class="btn btn-outline-secondary" onclick="previousStep(2)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <button class="btn btn-primary float-end" onclick="nextStep(4)">
                            Next <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Styling Configuration -->
                <div class="config-section" id="stylingStep" style="display: none;">
                    <h4><i class="fas fa-palette me-2"></i>Customize Appearance</h4>
                    <p class="text-muted">Configure the visual appearance of your widget</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Widget Title</label>
                                <input type="text" class="form-control" id="widgetTitle" placeholder="Enter widget title">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Widget Size</label>
                                <select class="form-select" id="widgetSize">
                                    <option value="small">Small (1/4 width)</option>
                                    <option value="medium" selected>Medium (1/2 width)</option>
                                    <option value="large">Large (3/4 width)</option>
                                    <option value="full">Full Width</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color Scheme</label>
                                <select class="form-select" id="colorScheme" onchange="updateColorPalette()">
                                    <option value="default">Default</option>
                                    <option value="blue">Blue</option>
                                    <option value="green">Green</option>
                                    <option value="red">Red</option>
                                    <option value="purple">Purple</option>
                                    <option value="orange">Orange</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chart Theme</label>
                                <select class="form-select" id="chartTheme">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="auto">Auto</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Show Legend</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showLegend" checked>
                                    <label class="form-check-label" for="showLegend">Display legend</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Show Grid</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showGrid" checked>
                                    <label class="form-check-label" for="showGrid">Display grid lines</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="customColorPalette" style="display: none;">
                        <h6>Custom Color Palette</h6>
                        <div class="row">
                            <div class="col-md-2">
                                <label class="form-label">Primary</label>
                                <input type="color" class="form-control color-picker" id="primaryColor" value="#007bff">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Secondary</label>
                                <input type="color" class="form-control color-picker" id="secondaryColor" value="#6c757d">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Success</label>
                                <input type="color" class="form-control color-picker" id="successColor" value="#28a745">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Warning</label>
                                <input type="color" class="form-control color-picker" id="warningColor" value="#ffc107">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Danger</label>
                                <input type="color" class="form-control color-picker" id="dangerColor" value="#dc3545">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Info</label>
                                <input type="color" class="form-control color-picker" id="infoColor" value="#17a2b8">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="previousStep(3)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <button class="btn btn-primary float-end" onclick="nextStep(5)">
                            Next <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 5: Preview -->
                <div class="config-section" id="previewStep" style="display: none;">
                    <h4><i class="fas fa-eye me-2"></i>Preview Widget</h4>
                    <p class="text-muted">Review your widget configuration and preview the result</p>
                    
                    <div class="preview-container" id="widgetPreview">
                        <div class="text-center">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Widget preview will appear here</p>
                            <button class="btn btn-primary" onclick="generatePreview()">
                                <i class="fas fa-play me-2"></i>Generate Preview
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="previousStep(4)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <button class="btn btn-success float-end" onclick="saveWidget()">
                            <i class="fas fa-save me-2"></i>Save Widget
                        </button>
                    </div>
                </div>
            </div>

            <!-- Configuration Summary Sidebar -->
            <div class="col-lg-4">
                <div class="config-section">
                    <h5><i class="fas fa-list me-2"></i>Configuration Summary</h5>
                    
                    <div class="mb-3">
                        <h6>Data Source</h6>
                        <p class="text-muted mb-1" id="summaryDataSource">Not selected</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Chart Type</h6>
                        <p class="text-muted mb-1" id="summaryChartType">Not selected</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Query</h6>
                        <p class="text-muted mb-1" id="summaryQuery">Not configured</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Styling</h6>
                        <p class="text-muted mb-1" id="summaryStyling">Default settings</p>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate()">
                                <i class="fas fa-file-import me-2"></i>Load Template
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="saveTemplate()">
                                <i class="fas fa-file-export me-2"></i>Save as Template
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="resetConfiguration()">
                                <i class="fas fa-undo me-2"></i>Reset Configuration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Help Section -->
                <div class="config-section">
                    <h6><i class="fas fa-question-circle me-2"></i>Need Help?</h6>
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#helpDataSource">
                                    Data Sources
                                </button>
                            </h2>
                            <div id="helpDataSource" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>Choose from available data sources like Prometheus, InfluxDB, or Elasticsearch. Make sure the connection is active.</small>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#helpQueries">
                                    Writing Queries
                                </button>
                            </h2>
                            <div id="helpQueries" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>Use the appropriate query language for your data source. Test your queries before saving.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let widgetConfig = {
            dataSource: null,
            chartType: null,
            query: null,
            styling: {}
        };
        let queryEditor = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadDataSources();
            initializeQueryEditor();
        });

        // Initialize CodeMirror editor
        function initializeQueryEditor() {
            queryEditor = CodeMirror.fromTextArea(document.getElementById('queryEditor'), {
                lineNumbers: true,
                mode: 'sql',
                theme: 'material',
                autoCloseBrackets: true,
                matchBrackets: true,
                indentWithTabs: true,
                smartIndent: true
            });
        }

        // Load available data sources
        async function loadDataSources() {
            try {
                const response = await fetch('/api/data-sources/test');
                const data = await response.json();
                
                const container = document.getElementById('dataSourceList');
                container.innerHTML = '';
                
                for (const [source, status] of Object.entries(data.results)) {
                    const card = document.createElement('div');
                    card.className = `data-source-card ${status ? '' : 'opacity-50'}`;
                    card.onclick = status ? () => selectDataSource(source) : null;
                    
                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${source}</h6>
                                <small class="text-muted">
                                    ${getDataSourceDescription(source)}
                                </small>
                            </div>
                            <div>
                                <span class="badge ${status ? 'bg-success' : 'bg-danger'}">
                                    ${status ? 'Connected' : 'Disconnected'}
                                </span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                }
            } catch (error) {
                console.error('Failed to load data sources:', error);
            }
        }

        // Get data source description
        function getDataSourceDescription(source) {
            const descriptions = {
                'prometheus': 'Metrics and monitoring data',
                'influxdb': 'Time series database',
                'elasticsearch': 'Search and analytics engine',
                'mysql': 'Relational database',
                'postgresql': 'Advanced relational database'
            };
            return descriptions[source] || 'Data source';
        }

        // Select data source
        function selectDataSource(source) {
            // Remove previous selection
            document.querySelectorAll('.data-source-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            event.currentTarget.classList.add('selected');
            
            widgetConfig.dataSource = source;
            updateSummary();
        }

        // Select chart type
        function selectChartType(type) {
            // Remove previous selection
            document.querySelectorAll('.chart-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            event.currentTarget.classList.add('selected');
            
            widgetConfig.chartType = type;
            updateSummary();
        }

        // Navigation functions
        function nextStep(step) {
            if (validateCurrentStep()) {
                showStep(step);
            }
        }

        function previousStep(step) {
            showStep(step);
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.config-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show current step
            const stepElements = {
                1: 'dataSourceStep',
                2: 'chartTypeStep',
                3: 'queryStep',
                4: 'stylingStep',
                5: 'previewStep'
            };
            
            document.getElementById(stepElements[step]).style.display = 'block';
            
            // Update step indicator
            updateStepIndicator(step);
            currentStep = step;
        }

        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < activeStep) {
                    step.classList.add('completed');
                } else if (i === activeStep) {
                    step.classList.add('active');
                }
            }
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    if (!widgetConfig.dataSource) {
                        alert('Please select a data source');
                        return false;
                    }
                    break;
                case 2:
                    if (!widgetConfig.chartType) {
                        alert('Please select a chart type');
                        return false;
                    }
                    break;
                case 3:
                    if (!queryEditor.getValue().trim()) {
                        alert('Please enter a query');
                        return false;
                    }
                    widgetConfig.query = queryEditor.getValue();
                    break;
                case 4:
                    // Collect styling configuration
                    widgetConfig.styling = {
                        title: document.getElementById('widgetTitle').value,
                        size: document.getElementById('widgetSize').value,
                        colorScheme: document.getElementById('colorScheme').value,
                        theme: document.getElementById('chartTheme').value,
                        showLegend: document.getElementById('showLegend').checked,
                        showGrid: document.getElementById('showGrid').checked
                    };
                    break;
            }
            return true;
        }

        // Update query editor mode based on query type
        function updateQueryEditor() {
            const queryType = document.getElementById('queryType').value;
            const modes = {
                'sql': 'sql',
                'prometheus': 'javascript',
                'elasticsearch': 'javascript',
                'influxdb': 'sql'
            };
            
            queryEditor.setOption('mode', modes[queryType] || 'sql');
        }

        // Update color palette visibility
        function updateColorPalette() {
            const colorScheme = document.getElementById('colorScheme').value;
            const customPalette = document.getElementById('customColorPalette');
            customPalette.style.display = colorScheme === 'custom' ? 'block' : 'none';
        }

        // Test connection
        async function testConnection() {
            if (!widgetConfig.dataSource) {
                alert('Please select a data source first');
                return;
            }
            
            try {
                const response = await fetch(`/api/data-sources/${widgetConfig.dataSource}/test`);
                const result = await response.json();
                
                if (result.success) {
                    alert('Connection successful!');
                } else {
                    alert('Connection failed: ' + result.error);
                }
            } catch (error) {
                alert('Connection test failed: ' + error.message);
            }
        }

        // Test query
        async function testQuery() {
            if (!widgetConfig.dataSource || !queryEditor.getValue().trim()) {
                alert('Please select a data source and enter a query');
                return;
            }
            
            try {
                const response = await fetch('/api/widgets/test-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data_source: widgetConfig.dataSource,
                        query: queryEditor.getValue(),
                        query_type: document.getElementById('queryType').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Query successful! Returned ${result.data.length} rows.`);
                } else {
                    alert('Query failed: ' + result.error);
                }
            } catch (error) {
                alert('Query test failed: ' + error.message);
            }
        }

        // Generate preview
        async function generatePreview() {
            try {
                const response = await fetch('/api/widgets/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(widgetConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const previewContainer = document.getElementById('widgetPreview');
                    previewContainer.innerHTML = '<div id="previewChart"></div>';
                    
                    Plotly.newPlot('previewChart', result.chart.data, result.chart.layout, {
                        responsive: true,
                        displayModeBar: false
                    });
                } else {
                    alert('Preview generation failed: ' + result.error);
                }
            } catch (error) {
                alert('Preview generation failed: ' + error.message);
            }
        }

        // Save widget
        async function saveWidget() {
            try {
                const response = await fetch('/api/widgets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(widgetConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Widget saved successfully!');
                    window.location.href = '/dashboards';
                } else {
                    alert('Failed to save widget: ' + result.error);
                }
            } catch (error) {
                alert('Failed to save widget: ' + error.message);
            }
        }

        // Update configuration summary
        function updateSummary() {
            document.getElementById('summaryDataSource').textContent = 
                widgetConfig.dataSource || 'Not selected';
            document.getElementById('summaryChartType').textContent = 
                widgetConfig.chartType || 'Not selected';
            document.getElementById('summaryQuery').textContent = 
                widgetConfig.query ? 'Configured' : 'Not configured';
            document.getElementById('summaryStyling').textContent = 
                Object.keys(widgetConfig.styling).length > 0 ? 'Customized' : 'Default settings';
        }

        // Template functions
        function loadTemplate() {
            alert('Load template functionality coming soon!');
        }

        function saveTemplate() {
            alert('Save template functionality coming soon!');
        }

        function resetConfiguration() {
            if (confirm('Are you sure you want to reset the configuration?')) {
                widgetConfig = {
                    dataSource: null,
                    chartType: null,
                    query: null,
                    styling: {}
                };
                
                queryEditor.setValue('');
                showStep(1);
                updateSummary();
            }
        }
    </script>
</body>
</html>